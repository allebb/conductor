#!/usr/bin/env bash

DIR=/etc/conductor/bin
source $DIR/_version

#############################################################
# Conductor CLI                                             #
# https://github.com/bobsta63/conductor                     #
# Created by: Bobby Allen (ballen@bobbyallen.me) 23/10/2013 #
#############################################################

# Function to echo out the help and info text.
function display_help {
    echo "Usage: conductor [OTPION]"
    echo ""
    echo "Options:"
    echo "  list              List all currently hosted applications"
    echo "  new {name}        Prepares and deploys a new application"
    echo "  destroy {name}    Removes an application from the server"
    echo "  update {name}     Upgrades an application via. Git"
    echo "  rollback {name}   Rolls back the most recent upgrade"
    echo "  depupdate {name}  Updates all application dependencies (composer update)"
    echo "  backup {name}     Backs up an application and dependent DB's"
    echo "  restore {name}    Restores an application and dependent DB's"
    echo "  start {name}      Starts a specific application (Laravel only)"
    echo "  stop {name}       Stops a specific application (Laravel only)"
    echo "  --start           Starts all dependent Conductor daemons"
    echo "  --stop            Stops all dependent Conductor daemons"
    echo "  --status          Displays the current daemon statuses"
    echo "  --restart         Restarts all dependent Conductor daemons"
    echo "  --reload          Reloads all dependent Conductor daemons"
    echo "  --version         Displays the version number of Conductor"
    echo "  --help            Displays this help screen."
    echo ""
    echo "Please report bug at: https://github.com/bobsta63/conductor"
}

# Function to execute a custom command via. artisan.
function execute_util() {
    sudo $DIR/conductor_$1 $2
}

# Lets work out what we need to do!
case "$1" in
        --start)
            /etc/init.d/php5-fpm start
            /etc/init.d/nginx start
            ;;

        --stop)
            /etc/init.d/php5-fpm stop
            /etc/init.d/nginx stop
            ;;

        --status)
            /etc/init.d/nginx status
            /etc/init.d/php5-fpm status
            ;;
        --restart)
            /etc/init.d/php5-fpm restart
            /etc/init.d/nginx restart
            ;;
        --reload)
            /etc/init.d/php5-fpm reload
            /etc/init.d/nginx reload
            ;;
        --version)
            echo "Conductor v.$VERSION"
            ;;
        --help)
            display_help $1
            exit 1
            ;;
        list)
            execute_util $1 true
            ;;
        new)
            execute_util $1 $2
            ;;
        destroy)
            execute_util $1 $2
            ;;
        update)
            execute_util $1 $2
            ;;
        rollback)
            execute_util $1 $2
            ;;
        depupdate)
            execute_util $1 $2
            ;;
        backup)
            execute_util $1 $2
            ;;
        restore)
            execute_util $1 $2
            ;;
        *)
            display_help $1
            exit 1
esac
