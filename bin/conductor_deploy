#!/usr/bin/env bash

# Load some configuration and 'common' code in...
BINDIR=/etc/conductor/bin
source $BINDIR/conf/conductor.conf
source $BINDIR/_headers $1 $2

# Application specific...
echo "Deploying application named: $APPNAME"
echo -n "Please enter the FQDN(s) this application: "
read DOMAIN
echo -n "Does this application require a MySQL DB? [Y/n] "
read MYSQLREQ

# If a MySQL database is required we'll create one now!
if [[ $MYSQLREQ == "y" || $MYSQLREQ == "Y" || $MYSQLREQ == "yes" || $MYSQLREQ == "Yes" ]]
then
    sudo cat <<EOF > $APPDIRECTORY/conductor_db.json
    {
        "appname": "$APPNAME",
        "password": "mypass",
        "type": "mysql"
    }
    EOF

    #Now we create the database user, db and assign the required permissions
    

fi

# Lets validate the Domain name to ensure it's valid!
PATTERN="^(([a-zA-Z0-9]|[a-zA-Z0-9][a-zA-Z0-9\-]*[a-zA-Z0-9])\.)*([A-Za-z0-9]|[A-Za-z0-9][A-Za-z0-9\-]*[A-Za-z0-9])$";
if [[ "$DOMAIN" =~ $PATTERN ]]; then
	DOMAIN=`echo $DOMAIN | tr '[A-Z]' '[a-z]'`
	echo "Creating application virtual host for:" $DOMAIN
else
	echo "Invalid domain name, pease try again!"
	exit 1
fi

# Now we need to copy the virtual host template
CONFIG=$NGINX_CONFIG/$APPNAME.conf
HTTPLOGPATH=($NGINX_LOGS/$APPNAME)
sudo cp $NGINX_TPLS/nginx_vhost_template.tpl $CONFIG
sudo sed -i "s/@@DOMAIN@@/$DOMAIN/g" $CONFIG
sudo sed -i "s/@@APPNAME@@/$APPNAME/g" $CONFIG
sudo sed -i "s/@@HTTPLOGPATH@@/$HTTPLOGPATH/g" $CONFIG

# Lets set up the directory structure and lock down some directory permissions.
sudo mkdir $APPDIRECTORY
sudo mkdir $LOGPATH
sudo chown $WEB_SERVER_GROUP:$WEB_SERVER_GROUP $APPDIRECTORY -R
sudo chown $WEB_SERVER_GROUP:$WEB_SERVER_GROUP $HTTPLOGPATH -R
sudo chmod 600 $CONFIG

# Now we need to reload Nginx!
sudo $NGINX_INIT reload