#!/usr/bin/env bash

# Load some configuration and 'common' code in...
BINDIR=/etc/conductor/bin
source $BINDIR/conf/conductor.conf
source $BINDIR/_headers $1 $2

# Application specific...
echo "Deploying application named: $APPNAME"
echo -e "Please enter the domain name: "
read DOMAIN
echo -e "Does this application require a MySQL DB? [Y/n] "
read MYSQLREQ

# Lets validate the Domain name to ensure it's valid!
PATTERN="^(([a-zA-Z0-9]|[a-zA-Z0-9][a-zA-Z0-9\-]*[a-zA-Z0-9])\.)*([A-Za-z0-9]|[A-Za-z0-9][A-Za-z0-9\-]*[A-Za-z0-9])$";
if [[ "$DOMAIN" =~ $PATTERN ]]; then
	DOMAIN=`echo $DOMAIN | tr '[A-Z]' '[a-z]'`
	echo "Creating application virtual host for:" $DOMAIN
else
	echo "Invalid domain name, pease try again!"
	exit 1
fi



# Now we need to copy the virtual host template
CONFIG=$NGINX_CONFIG/$APPNAME.conf
LOG_PATH=$NGINX_LOGS/$APPNAME
sudo cp $NGINX_TPLS/nginx_vhost_template.tpl $CONFIG
sudo sed -i "s/@@DOMAIN@@/$DOMAIN/g" $CONFIG
sudo sed -i "s/@@APPNAME@@/$APPNAME/g" $CONFIG
sudo sed -i "s/@@LOG_PATH@@/$LOG_PATH/g" $CONFIG

# Lets set up the directory structure and lock down some directory permissions.
sudo mkdir $APPDIRECTORY
sudo mkdir $LOGPATH
sudo chown $WEB_SERVER_GROUP:$WEB_SERVER_GROUP -R $APPDIRECTORY
sudo chown $WEB_SERVER_GROUP:$WEB_SERVER_GROUP -R $LOGPATH
sudo chmod 600 $CONFIG

# Now we need to reload Nginx!
sudo $NGINX_INIT reload