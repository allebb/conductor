#!/usr/bin/env bash

# Load some configuration and 'common' code in...
BINDIR=/etc/conductor/bin
source $BINDIR/conf/conductor.conf
source $BINDIR/_headers

# Application specific...
if [ -d "$APPDIRECTORY" ]; then
	if [ -f "$BACKUP_DIR/rollback_$APPNAME.tar.gz" ];
	then
		echo "Rolling back previous 'upgrade'..."
		 mkdir $TEMP_DIR/restore_$APPNAME
		# Now we'll extract the backup archive
		 tar -zxf $BACKUP_DIR/rollback_$APPNAME.tar.gz -C $TEMP_DIR/restore_$APPNAME

		# Restore DB if found...
		if [ -f "$TEMP_DIR/restore_$APPNAME/appdb.sql.gz" ];
		then
			echo "Importing application MySQL database..."	
			# Re-import the database into MySQL
			 gunzip < $TEMP_DIR/restore_$APPNAME/appdb.sql.gz | mysql -u $MYSQLUSER -p$MYSQLPASS db_$APPNAME
			echo "Finished importing MySQL database!"
			 rm $TEMP_DIR/restore_$APPNAME/appdb.sql.gz
		else
			echo "No database archive was found, skipping DB import!"
		fi

		# Now we delete and move the application files to the application root...
		 rm -Rf $APPDIRECTORY
		 cp -Rf $TEMP_DIR/restore_$APPNAME/ $APPDIRECTORY/
		# We now need to re-apply directory permissions..
		 chown $WEB_SERVER_GROUP:$WEB_SERVER_GROUP $APPDIRECTORY -R
		# Lets clean up the temp directory...
		 rm -Rf $TEMP_DIR/restore_$APPNAME
		echo "...finished!"
		exit 0
	else
		echo "The roll-back snapshot could not be found, maybe this was manually deleted or an upgrade has not yet been completed!"
		exit 1
	fi
else
	echo "Application does not exists!"
	exit 1
fi
