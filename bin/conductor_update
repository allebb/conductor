#!/usr/bin/env bash

# Load some configuration and 'common' code in...
BINDIR=/etc/conductor/bin
source $BINDIR/conf/conductor.conf
source $BINDIR/_headers

if [ -d "$APPDIRECTORY" ]; then
    
    if [[ $2 == "--force" ]]
    then
        echo "Forcing application upgrade..."
        TAKEDOWN=no
    else
        read -p "Do you wish to 'take down' the application before upgrading? [Y/n] " TAKEDOWN
    fi

    if [[ $TAKEDOWN == "y" || $TAKEDOWN == "Y" || $TAKEDOWN == "yes" || $TAKEDOWN == "Yes" ]]
    then
        echo "Creating application and snapshot..."
        if [ -f "$BACKUP_DIR/rollback_$APPNAME.tar.gz" ];
        then
            sudo rm $BACKUP_DIR/rollback_$APPNAME.tar.gz
        fi
        backupApplication rollback_$APPNAME.tar.gz
        echo "Starting application upgrade..."
        if [ -f "$APPDIRECTORY/artisan" ]; then
            sudo php $APP_ROOT/$APPNAME/artisan down
        fi
        if [ -d "$APPDIRECTORY/.git" ]; then
            gitPullReset
        fi
        sudo chown $WEB_SERVER_GROUP:$WEB_SERVER_GROUP $APPDIRECTORY -R
        laravelMigrate
        if [ -f "$APPDIRECTORY/artisan" ]; then
            sudo php $APP_ROOT/$APPNAME/artisan up
        fi
        echo "...finished!"
        exit 0
    else
        echo "Creating application and snapshot..."
        if [ -f "$BACKUP_DIR/rollback_$APPNAME.tar.gz" ];
        then
            sudo rm $BACKUP_DIR/rollback_$APPNAME.tar.gz
        fi
        backupApplication rollback_$APPNAME.tar.gz
        echo "Starting application upgrade..."
        if [ -d "$APPDIRECTORY/.git" ]; then
            gitPullReset
        fi
        sudo chown $WEB_SERVER_GROUP:$WEB_SERVER_GROUP $APPDIRECTORY -R
        laravelMigrate
        echo "...finished!"
        exit 0
    fi
else
    echo "Application does not exist!"
    exit 1
fi