#!/usr/bin/env bash

# Load some configuration and 'common' code in...
BINDIR=/etc/conductor/bin
source $BINDIR/conf/conductor.conf
source $BINDIR/_headers

# Application specific...
function gitPullReset() {
    echo "Starting upgrade from Git..."
    sudo /usr/bin/git --git-dir=$APPDIRECTORY/.git --work-tree=$APPDIRECTORY reset --hard
    sudo /usr/bin/git --git-dir=$APPDIRECTORY/.git --work-tree=$APPDIRECTORY pull
}

function resetApplicationCacheMigrate() {
    echo "Resetting application ownership permissions..."
    sudo chown $WEB_SERVER_GROUP:$WEB_SERVER_GROUP $APPDIRECTORY -R
    sudo php $APP_ROOT/$APPNAME/artisan migrate
    sudo php $APP_ROOT/$APPNAME/artisan dump-autoload
    sudo php $APP_ROOT/$APPNAME/artisan cache:clear
}

if [ -d "$APPDIRECTORY" ]; then
    read -p "Do you wish to 'take down' the application before upgrading? [Y/n] " TAKEDOWN
    if [[ $TAKEDOWN == "y" || $TAKEDOWN == "Y" || $TAKEDOWN == "yes" || $TAKEDOWN == "Yes" ]]
    then
        echo "Creating application and snapshot..."

        if [ -f $BACKUP_DIR/rollback_$APPNAME.tar.gz ];
        then
            sudo rm $BACKUP_DIR/rollback_$APPNAME.tar.gz
        fi
        backupApplication rollback_$APPNAME.tar.gz
        echo "Starting application upgrade..."
        sudo php $APP_ROOT/$APPNAME/artisan down
        gitPullReset
        #sudo /usr/bin/composer update --no-dev -o --working-dir=$APPDIRECTORY
        resetApplicationCacheMigrate
        sudo php $APP_ROOT/$APPNAME/artisan up
        echo "...finished!"
    else
        echo "Creating application and snapshot..."
        sudo rm $BACKUP_DIR/rollback_$APPNAME.tar.gz
        backupApplication rollback_$APPNAME.tar.gz
        echo "Starting application upgrade..."
        gitPullReset
        #sudo /usr/bin/composer update --no-dev -o --working-dir=$APPDIRECTORY
        resetApplicationCacheMigrate
        echo "...finished!"
        exit 0
    fi
else
    echo ""
    echo "The application does not appear to exist on this server!"
    echo
    exit 1
fi